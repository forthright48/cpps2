module.exports = function(input) {
  let output = '';
  let state = 'normal';

  const len = input.length;

  for (let i = 0; i < len;) {
    const c = input[i];
    if (c === '$') {
      // Something is going to happen
      if (state === 'normal') {
        // Maybe go from normal to latex?
        if (i + 1 < len && input[i + 1] === '$') {
          output += '$$';
          i += 2;
          state = 'double$';
        } else {
          output += '$';
          i++;
          state = 'single$';
        }
      } else if (state === 'double$') {
        // Close double $$ latex?
        if (i + 1 < len && input[i + 1] === '$') {
          // Close down $$
          output += '$$';
          i += 2;
          state = 'normal';
        } else {
          // No change in state
          output += c;
          i++;
        }
      } else if (state === 'single$') {
        // Close single $ latex?
        output += c;
        i++;
        state = 'normal';
      }
    } else {
      if (state === 'normal') {
        output += c;
        i++;
      } else if (state === 'single$' || state === 'double$') {
        // Escape special characters
        if (c === '_' || c === '*') {
          output += `\\${c}`;
        } else {
          output += c;
        }
        i++;
      }
    }
  }

  return output;
};
